import{d as E,u as T,c as m,a as l,b as r,t as v,n as w,e as s,f as g,g as O,o,P as n,h as N,r as S,i as L,j,k as V,l as I,F,m as U,p as z,q as M}from"./index-2e7e31eb.js";import{u as A}from"./game-3dc6fb51.js";import{G as Y}from"./game-9e9cc508.js";const q={class:"flex justify-start items-center"},H={class:"flex justify-center items-center rounded-full bg-neutral-400 text-neutral-700 text-ellipsis h-10 w-10 p-1 text-xs text-ellipsis overflow-hidden"},J={class:"ml-2 flex flex-col"},K={class:"text-gray-800/80"},k=E({__name:"PeerItem",props:{peerId:null,self:{type:Boolean}},setup(h){const c=h,a=T(),i=m(()=>_(f.value)),f=m(()=>c.self===!0?a.connectionState:a.peerConnectionStates[c.peerId]),_=p=>{switch(p){case n.INITIAL:return"Initial state";case n.CONNECTING:return"Connecting...";case n.CONNECTED:return"Connection successful";case n.ERROR:return"Error during connection";case n.DISCONNECTED:return"Disconnected from peer";case n.NOT_FOUND:return"Could not find peer after 3 reconnection attempts"}},t=m(()=>{switch(f.value){case n.INITIAL:case n.CONNECTING:default:return 0;case n.CONNECTED:return 1;case n.ERROR:case n.NOT_FOUND:case n.DISCONNECTED:return 2}});return(p,u)=>(o(),l("div",q,[r("div",H,v(h.self?"YOU":c.peerId.slice(0,4)),1),r("div",J,[r("div",K,v(c.peerId),1),r("div",{class:w([{"text-sky-400":s(t)===0,"text-green-400":s(t)===1,"text-red-500":s(t)===2},"flex justify-start items-center"])},[s(t)!==2?(o(),l("span",{key:0,class:w(["inline-block h-2 w-2 rounded-full animate-pulse mr-2",{"bg-sky-400":s(t)===0,"bg-green-400":s(t)===1}])},null,2)):g("",!0),O(" "+v(s(i)),1)],2)])]))}}),Q={class:"h-full w-full bg-blue-700 flex flex-col flex-wrap gap-8 justify-center items-center"},W=r("span",{class:"text-xs"},"<",-1),X={class:"bg-white shadow-md rounded-lg p-8 text-blue-950 max-w-full lg:max-w-lg"},Z={class:"text-lg font-mono mb-3"},ee=r("hr",{class:"mt-4 mb-4 border-gray-100"},null,-1),te={key:1},ne={key:2},se=r("p",{class:"text-xs text-gray-500 mb-2"},"Connected members",-1),oe={key:0,class:"divide-y"},re={key:1,class:"text-fuchsia-400 text-sm"},ie=E({__name:"LobbyView",setup(h){const c="[LobbyView]",a=T();let{peerService:i}=N();const f=S(!1),t=A({networked:!0,multiplayer:!0}).gameService,p=m(()=>M().params.lobbyId),u=S(0),b=m(()=>p.value===a.peerId),x=m(()=>Object.keys(a.peerConnectionStates)),G=async e=>{u.value=2,console.log(`${c} Connecting to lobby ${e}`);try{await i.value.connectToPeer(e,!0),t.initMultiplayer()}catch(d){console.error(`${c} Could not connect to lobby ${e}`),console.error(d);return}u.value=3},D=async(e,d)=>{if([n.CONNECTING,n.CONNECTED].includes(a.connectionState)){console.log(c+" Peer is already connecting or connected, skipping init"),u.value=2;return}try{u.value=1,console.log(c+` Initializing self with ${d?"id "+e:"new id"}`),await i.value.initSelf(e??void 0,d),u.value=2}catch{console.error(`${c} Initialization new id failed;`)}},C=async()=>{i===void 0&&(i=N().peerService),await D(a.peerId,b.value),i.value.peerConnections.filter(e=>e.provider.id===p.value).length==0&&p.value!==a.peerId?await G(p.value):u.value=3};L(async(e,d,y)=>{await C(),y()}),j(()=>{if((t==null?void 0:t.context.status)===Y.started)return!0;const e=confirm("waaaait you will be removed from the lobby if you leave!");return e&&i.value.destroy(),e}),V(async()=>{await C()});const $=()=>{t.initMultiplayer();const e=t.peerService.peerConnections.map(d=>d.peer);e.push(a.peerId),t.startGame(e)},B=()=>{t.pauseGame()},P=async()=>{z.push("/")};return(e,d)=>(o(),l("div",Q,[r("div",null,[r("div",{class:"flex justify-start items-center mb-4"},[r("button",{class:"rounded-full px-3 py-1 bg-slate-400/20 border border-slate-400 mix-blend-lighten text-slate-200 text-sm hover:bg-slate-400/90 hover:text-white focus:bg-slate-400/90 focus:text-white",onClick:P},[W,O(" Back ")])]),r("div",X,[r("h3",Z,v(s(b)?"Your":"The")+" game lobby",1),s(a).peerId!==null?(o(),I(k,{key:0,"peer-id":s(a).peerId,self:""},null,8,["peer-id"])):g("",!0),ee,u.value===1?(o(),l("div",te," Initialising peer... ")):(o(),l("div",ne,[se,s(x).length>0?(o(),l("ul",oe,[(o(!0),l(F,null,U(s(x),(y,R)=>(o(),I(k,{key:R,"peer-id":y,class:"py-2"},null,8,["peer-id"]))),128))])):(o(),l("p",re,"No peers connected")),s(b)?(o(),l("button",{key:2,class:"w-full mt-6 bg-blue-700/40 hover:bg-blue-700/60 border border-blue-700 rounded-lg p-2",onClick:$},"Start Game")):g("",!0),s(b)&&f.value?(o(),l("button",{key:3,class:"w-full mt-6 bg-blue-700/40 hover:bg-blue-700/60 border border-blue-700 rounded-lg p-2",onClick:B},"Pause Game")):g("",!0)]))])])]))}});export{ie as default};
