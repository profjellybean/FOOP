var h=Object.defineProperty;var l=(i,e,t)=>e in i?h(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var n=(i,e,t)=>(l(i,typeof e!="symbol"?e+"":e,t),t);import{j as p}from"./index-765fa3d2.js";function r(i){if(typeof i!="object")return i;var e,t,s=Object.prototype.toString.call(i);if(s==="[object Object]"){if(i.constructor!==Object&&typeof i.constructor=="function"){t=new i.constructor;for(e in i)i.hasOwnProperty(e)&&t[e]!==i[e]&&(t[e]=r(i[e]))}else{t={};for(e in i)e==="__proto__"?Object.defineProperty(t,e,{value:r(i[e]),configurable:!0,enumerable:!0,writable:!0}):t[e]=r(i[e])}return t}if(s==="[object Array]"){for(e=i.length,t=Array(e);e--;)t[e]=r(i[e]);return t}return s==="[object Set]"?(t=new Set,i.forEach(function(o){t.add(r(o))}),t):s==="[object Map]"?(t=new Map,i.forEach(function(o,m){t.set(r(m),r(o))}),t):s==="[object Date]"?new Date(+i):s==="[object RegExp]"?(t=new RegExp(i.source,i.flags),t.lastIndex=i.lastIndex,t):s==="[object DataView]"?new i.constructor(r(i.buffer)):s==="[object ArrayBuffer]"?i.slice(0):s.slice(-6)==="Array]"?new i.constructor(i):i}class y{constructor(e){n(this,"numberOfMice",25);n(this,"mouseWinCounter",0);n(this,"map");n(this,"mousePos");n(this,"goalPos");this.map=e}async updateMousePosition(e){return new Promise((t,s)=>{this.mousePos=new a(e.getComponent("pos").x,e.getComponent("pos").y),this.goalPos=new a(e.getComponent("goal").x,e.getComponent("goal").y);const o=this.calcStep();this.map.value.map[this.mousePos.x][this.mousePos.y].occupied=null,this.map.value.map[o.x][o.y].occupied=e,(o.x===this.goalPos.x&&o.y===this.goalPos.y||this.mousePos.x===this.goalPos.x&&this.mousePos.y===this.goalPos.y)&&(e.getComponent("isAlive").isAlive=!1,this.mouseWinCounter++,t()),e.getComponent("pos").x=o.x,e.getComponent("pos").y=o.y,t()})}getInitialMouseX(){return Math.floor(Math.random()*100)}getInitialMouseY(){return Math.floor(Math.random()*100)}calcStep(){const e=this.mousePos.x-this.goalPos.x,t=this.mousePos.y-this.goalPos.y;return e>0?t>0?new a(this.mousePos.x-1,this.mousePos.y-1):new a(this.mousePos.x-1,this.mousePos.y+1):e<0?t>0?new a(this.mousePos.x+1,this.mousePos.y-1):new a(this.mousePos.x+1,this.mousePos.y+1):t>0?new a(this.mousePos.x,this.mousePos.y-1):new a(this.mousePos.x,this.mousePos.y+1)}getNumberOfMice(){return this.numberOfMice}getMouseWinCounter(){return this.mouseWinCounter}}class a{constructor(e,t){n(this,"x");n(this,"y");this.x=e,this.y=t}}class f{constructor(e){n(this,"_entityCount",0);n(this,"_entities",{});n(this,"numberOfMice");this.numberOfMice=e}getMouse(e){return this._entities[`${e}`]}isAlive(e){return this._entities[`${e}`].getComponent("isAlive").isAlive}createEntity(e){if(e||(e=this._entityCount.toString()),this._entities[e])throw new Error(`Entity with ID ${e} already exists`);const t=new d(e);return this._entities[t.id]=t,this._entityCount++,t}importEntities(e){this._entities={...this._entities,...e}}update(e){this.importEntities(e)}}class d{constructor(e){n(this,"id");n(this,"components",{});this.id=e}addComponent(e,t){this.components[e.compName]=e.init(t)}getComponent(e){return this.components[e]}}class c{constructor(){n(this,"compName","ap");n(this,"shape")}init(e){return{shape:e.shape??"mouse"}}}class u{constructor(e){n(this,"compName");n(this,"x");n(this,"y");this.compName=e}init(e){return{x:e.x??0,y:e.y??0}}}class g{constructor(){n(this,"compName","isAlive");n(this,"isAlive")}init(e){return{isAlive:e??!1}}}class w{constructor(){n(this,"compName","map");n(this,"map")}init(e){this.map=Array(100);for(let t=0;t<100;t++){this.map[t]=new Array(100);for(let s=0;s<100;s++)t%20===0&&t!==0?this.map[t][s]={occupied:null,type:"underground"}:this.map[t][s]={occupied:null,type:"surface"}}return this.map[80][0]={occupied:null,type:"meeting"},this.map[20][10]={occupied:null,type:"entry"},this.map[20][80]={occupied:null,type:"entry"},this.map[40][90]={occupied:null,type:"entry"},this.map[40][20]={occupied:null,type:"entry"},this.map[60][10]={occupied:null,type:"entry"},this.map[60][30]={occupied:null,type:"entry"},this.map[80][90]={occupied:null,type:"entry"},this.map}}class b{constructor(e,t,s,o){n(this,"logTag","[GameService]");n(this,"_settings");n(this,"gameFinished",!1);n(this,"peerService");n(this,"entitySystem");n(this,"map",p(new w));n(this,"numberOfMice");n(this,"currentState",p({}));n(this,"stateBuffer",{});n(this,"mouseHelper");this._settings=s??{gameId:"game1",multiplayer:!1,networked:!1},this.mouseHelper=new y(this.map),this.numberOfMice=this.mouseHelper.getNumberOfMice(),this.peerService=e,this.entitySystem=t??new f(this.numberOfMice),this.map.value.init()}updateOpponentPosition(){for(let e=1;e<=this.numberOfMice;e++){const t=this.entitySystem.getMouse(e.toString());this.entitySystem.isAlive(t.id)&&this.mouseHelper.updateMousePosition(t)}}startGame(e){this.currentState.value={players:{...this.generatePlayers(e)},opponents:{...this.generateOpponents()}},this.stateBuffer={...this.currentState.value},this._settings.multiplayer&&this._settings.networked&&this.peerService.send({type:"start_game",value:{state:this.currentState.value}}),window.requestAnimationFrame(this._gameLoop.bind(this))}generatePlayers(e=[]){const t={};for(const s of e){const o=this.entitySystem.createEntity(s);o.addComponent(new c,{shape:"cat"}),o.addComponent(new u("pos"),{x:50,y:50}),t[o.id]=o}return t}generateOpponents(){const e={};for(let t=0;t<this.numberOfMice;++t){const s=this.entitySystem.createEntity();s.addComponent(new c,{shape:"mouse"}),s.addComponent(new u("pos"),{x:this.mouseHelper.getInitialMouseX(),y:this.mouseHelper.getInitialMouseY()}),s.addComponent(new u("goal"),{x:80,y:0}),s.addComponent(new g,{isAlive:!0}),e[s.id]=s}return e}emit(e,t,s){const o=r(this.stateBuffer.players[e]);if(!o){console.warn(`${this.logTag} Entity with ID ${e} not found`);return}switch(t){case"move":this._handleMove(o,s);break}this.stateBuffer.players[e]=o}checkBorder(e,t){return!(this.map.value.map[e]==null||this.map.value.map[e][t]==null)}_handleMove(e,t){const s=e.getComponent("pos");switch(t){case"up":if(!this.checkBorder(s.x-1,s.y))break;this.map.value.map[s.x][s.y].occupied=null,s.x=s.x-1,this.map.value.map[s.x][s.y].occupied=e;break;case"right":if(!this.checkBorder(s.x,s.y+1))break;this.map.value.map[s.x][s.y].occupied=null,s.y=s.y+1,this.map.value.map[s.x][s.y].occupied=e;break;case"left":if(!this.checkBorder(s.x-1,s.y-1))break;this.map.value.map[s.x][s.y].occupied=null,s.y=s.y-1,this.map.value.map[s.x][s.y].occupied=e;break;case"down":if(!this.checkBorder(s.x+1,s.y))break;this.map.value.map[s.x][s.y].occupied=null,s.x=s.x+1,this.map.value.map[s.x][s.y].occupied=e;break;default:console.warn(`${this.logTag} Unknown direction ${t}`)}}_gameLoop(){this.updateOpponentPosition(),this._settings.multiplayer&&this._settings.networked&&this.peerService.send({type:"update",value:this.stateBuffer}),this.entitySystem.update(this.stateBuffer.players),this.entitySystem.update(this.stateBuffer.opponents),this.stateBuffer={...this.currentState.value},this.gameFinished!==!0&&window.requestAnimationFrame(this._gameLoop.bind(this))}}export{b as G};
